<html>
	<head>
		<title> CONTROLLER YO </title>

        <meta name="viewport" content="width=device-width, initial-scale=1, minimum-sacle=1, maximum-scale=1, user-scalable=no">

        <script type="text/javascript" src="src\Util\MessageTypes.js"></script>
        <script type="text/javascript" src="src\Util\Connection.js"></script>

        <style type="text/css">
            #page-container { }

            #button-view {
                
            }

            #loading-screen {
            }

            body { 
                height: 100%;
                width:100%;
                overflow:hidden;
                overflow-x: hidden;
                overflow-y: hidden;
            }

            .button-screen {
                width: 100%;
                height: 100%;
            }

            #dpad {
                margin-left: 5%;
                margin-top: 8%;
                width: 40%;
                height: 80%;
                position: relative;
            }

            .arrow-key {
                position: absolute;
                width: 45%;
                height: 45%;
                color: rgba(0,0,0,0);
                border: none;
            }

            #button-left { top: 27%; } 
            #button-right { top: 27%; left: 54%; }
            #button-up { left: 27%; }
            #button-down { left: 27%; top: 54%; }

            .hidden { display: none; }
        </style>
	</head>

	<body>
        <div id="page-container">
            <div id="connect-screen" class="hidden">
                <button id="connect-button">Connect</button>
            </div>

            <div id="loading-screen" class="hidden">
                <img src="assets/throbber.gif" alt="loading" />
            </div>

            <div id="start-screen" class="hidden">
                <p> Waiting on game start </p>
                <button id="start-game"> Start game </button>
            </div>

            <div id="countdown-screen" class="hidden">
                Game Beginning!!
            </div>

            <div id="button-screen" class="ahidden">
                <div id="dpad">
                    <img id="button-left" class="arrow-key" src="assets/controller/but_left.png" />
                    <img id="button-up" class="arrow-key" src="assets/controller/but_up.png" />
                    <img id="button-down" class="arrow-key" src="assets/controller/but_down.png" />
                    <img id="button-right" class="arrow-key" src="assets/controller/but_right.png" />
                </div>
            </div>
        </div>

		<script type="text/javascript">
            "use strict";
			
			let url = CONNECTION_URL;
            let connection = null;

            let connectButton = document.querySelector("#connect-button");
            let startGameButton = document.querySelector("#start-game");

            let connectScreen = document.querySelector("#connect-screen");
            let startScreen = document.querySelector("#start-screen");
            let loadingScreen = document.querySelector("#loading-screen");
            let countDownTime = document.querySelector("#countdown-screen");
            let controllerScreen = document.querySelector("#button-screen");

            let buttonUp = document.querySelector("#button-up");
            let buttonDown = document.querySelector("#button-down");
            let buttonLeft = document.querySelector("#button-left");
            let buttonRight = document.querySelector("#button-right");

            let playerId = null;
            let startDateTime = null;
            let currentDirection = null;

            document.body.addEventListener('touchmove', function(e){ e.preventDefault(); });
            window.addEventListener("scroll",function(){ window.scrollTo(0,0) },false)
            window.addEventListener("load",function() {
                // Set a timeout...
               setTimeout(function(){
                    // Hide the address bar!
                    window.scrollTo(0, 1);
                }, 1);
            });

            buttonLeft.addEventListener("mouseover", function(x) { buttonLeft.src = "assets/controller/but_left_active.png"; });
            buttonLeft.addEventListener("mouseout", function(x) { buttonLeft.src = "assets/controller/but_left.png"; });
            buttonUp.addEventListener("mouseover", function(x) { buttonUp.src = "assets/controller/but_up_active.png"; });
            buttonUp.addEventListener("mouseout", function(x) { buttonUp.src = "assets/controller/but_up.png"; });
            buttonDown.addEventListener("mouseover", function(x) { buttonDown.src = "assets/controller/but_down_active.png"; });
            buttonDown.addEventListener("mouseout", function(x) { buttonDown.src = "assets/controller/but_down.png"; });
            buttonRight.addEventListener("mouseover", function(x) { buttonRight.src = "assets/controller/but_right_active.png"; });
            buttonRight.addEventListener("mouseout", function(x) { buttonRight.src = "assets/controller/but_right.png"; });

            buttonLeft.addEventListener("touchstart", function(x) { buttonLeft.src = "assets/controller/but_left_active.png"; });
            buttonLeft.addEventListener("touchend", function(x) { buttonLeft.src = "assets/controller/but_left.png"; });
            buttonUp.addEventListener("touchstart", function(x) { buttonUp.src = "assets/controller/but_up_active.png"; });
            buttonUp.addEventListener("touchend", function(x) { buttonUp.src = "assets/controller/but_up.png"; });
            buttonDown.addEventListener("touchstart", function(x) { buttonDown.src = "assets/controller/but_down_active.png"; });
            buttonDown.addEventListener("touchend", function(x) { buttonDown.src = "assets/controller/but_down.png"; });
            buttonRight.addEventListener("touchstart", function(x) { buttonRight.src = "assets/controller/but_right_active.png"; });
            buttonRight.addEventListener("touchend", function(x) { buttonRight.src = "assets/controller/but_right.png"; });

            function startCountDown(msg) {
                startScreen.classList.add("hidden");
                loadingScreen.classList.add("hidden");
                countDownTime.classList.remove("hidden");

                startDateTime = new Date(msg.Data.Time);

                setInterval(continueCountDown, 800);
            }

            function continueCountDown() {

                var currentDateTime = new Date();
                var span = (startDateTime.getTime() - currentDateTime.getTime()) / 1000;

                countDownTime.innerText = Math.ceil(span);

                if (span <= 0) {
                    clearInterval(continueCountDown);
                    startGame();
                }
            }

            function startGame() {
                countDownTime.classList.add("hidden");
                controllerScreen.classList.remove("hidden");               

                buttonUp.addEventListener("mousedown", function() { setDirection(1); });
                buttonRight.addEventListener("mousedown", function() { setDirection(2); });
                buttonDown.addEventListener("mousedown", function() { setDirection(3); });
                buttonLeft.addEventListener("mousedown", function() { setDirection(4); });
            }

            function setDirection(dir) {
                if (currentDirection === dir)
                    return;

                currentDirection = dir;
                connection.send({Type: MessageTypes.Command, Data: { playerId: playerId, direction: dir }});
            }

            connectButton.addEventListener("click", function() {
                connectScreen.classList.add("hidden");
                loadingScreen.classList.remove("hidden");

                connection = new Connection(url, {
                    onConnect: function(event) {  
                        connection.send({ Type: MessageTypes.RegisterTalk });
                    },
                    onReceive: function(msg) {
                        if (msg.Type != MessageTypes.PlayerIdAssigned)
                            throw "Received wrong message, this is a problem.";

                        playerId = msg.Data.Id;

                        startScreen.classList.remove("hidden");

                        connection.onReceive = function(msg) {
                            if (msg.Type != MessageTypes.StartTimer)
                                throw "Received wrong message, this is a problem.";

                            startCountDown(msg);
                        }
                    },
                })
            });

	        startGameButton.addEventListener("click", function() {
                connection.send({ Type: MessageTypes.Start, Data: { PlayerId: playerId } });

                startScreen.classList.remove("hidden");
            });    

		</script>
	</body>
</html>
